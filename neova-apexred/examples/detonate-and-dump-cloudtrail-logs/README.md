# Example: Detonating Stratus Red Team programmatically to understand the logs that an attack technique generates

This example shows a more advanced example of detonating an attack using Stratus Red Team, 
then using the Datadog API to query the CloudTrail logs generated by this detonation.

This is made possible by the fact that Stratus Red Team injects an unique header (`stratus-red-team_<uuid>`) 
in the user-agent of requests it performs.

Usage:

```
$ go run dump-logs.go aws.defense-evasion.cloudtrail-delete cloudtrail-logs.json
```

Sample output (note that CloudTrail logs by design take several minutes to be delivered by AWS):

``` 
Detonating 'aws.defense-evasion.cloudtrail-delete' with Stratus Red Team
Execution UID: b071a414-5f74-48d8-9346-31e3b01a24e3
Searching for logs in Datadog
No logs found. Sleeping for 1m0s
Searching for logs in Datadog
No logs found. Sleeping for 1m0s
Searching for logs in Datadog
Found 1 matching logs
```

Here, `cloudtrail-logs.json` will contain (redacted for clarity):

```json
[
  {
    "awsRegion": "us-east-1",
    "eventCategory": "Management",
    "eventID": "df1dd5f2-4891-4c74-9918-2c10ba1bbd5a",
    "eventName": "DeleteTrail",
    "eventSource": "cloudtrail.amazonaws.com",
    "eventTime": "2022-07-29T21:17:04Z",
    "eventType": "AwsApiCall",
    "eventVersion": "1.08",
    "evt": {
      "name": "DeleteTrail"
    },
    "http": {
      "useragent": "stratus-red-team_b071a414-5f74-48d8-9346-31e3b01a24e3",
    },
    "managementEvent": true,
    "readOnly": false,
    "recipientAccountId": "012345678912",
    "requestParameters": {
      "name": "my-cloudtrail-trail-2"
    },
    "service": "cloudtrail",
    "timestamp": 1659129552928,
    "userIdentity": {
      "accessKeyId": "ASIA...ZICY",
      "accountId": "012345678912",
      "arn": "arn:aws:sts::012345678912:assumed-role/my-role/christophetd",
      "assumed_role": "my-role",
      "principalId": "AROA...N6U4:christophetd",
      "type": "AssumedRole"
    }
  }
]
```